<UserControl xmlns="https://github.com/avaloniaui"
			 xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
			 xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
			 xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
			 xmlns:converters="clr-namespace:WateryTart.Core.Converters"
			 xmlns:vm="clr-namespace:WateryTart.Core.ViewModels"
			 xmlns:app="clr-namespace:WateryTart.Core"
			 xmlns:behaviors="clr-namespace:WateryTart.Core.Behaviors"
			 xmlns:asyncImageLoader="clr-namespace:AsyncImageLoader;assembly=AsyncImageLoader.Avalonia"
			 xmlns:materialIcons="using:Material.Icons.Avalonia"
			 mc:Ignorable="d" d:DesignWidth="800" d:DesignHeight="450"
			 x:Class="WateryTart.Core.Views.TracksView"
			 x:DataType="vm:TracksViewModel">
	<UserControl.Resources>
		<converters:MetadataImageConverter x:Key="MetadataImageConverter" />
		<converters:ArtistsToStringConverter x:Key="ArtistsToStringConverter" />
		<converters:FriendlyTimeConverter x:Key="FriendlyTimeConverter" />
	</UserControl.Resources>
	
	<Grid>
		<Grid.RowDefinitions>
			<RowDefinition Height="*" />
			<RowDefinition Height="Auto" />
		</Grid.RowDefinitions>
		
		<!-- Tracks List with Infinite Scroll Behavior -->
		<ListBox Grid.Row="0" x:Name="lbTracks" ItemsSource="{Binding Tracks}" Background="Transparent">
			<Interaction.Behaviors>
				<behaviors:ListScrollBehavior 
					LoadMoreCommand="{Binding LoadMoreCommand}"
					IsLoading="{Binding IsLoading}"
					HasMoreItems="{Binding HasMoreItems}"
					Threshold="10" />
			</Interaction.Behaviors>
			<ListBox.ItemTemplate>
				<DataTemplate>
					<Grid Margin="5">
						<Grid.ColumnDefinitions>
							<ColumnDefinition Width="60" />
							<ColumnDefinition Width="*" />
							<ColumnDefinition Width="Auto" />
							<ColumnDefinition Width="Auto" />
						</Grid.ColumnDefinitions>

						<Border ClipToBounds="True"
								Margin="0,0,10,0"
								CornerRadius="5"
								Grid.Column="0">
							<asyncImageLoader:AdvancedImage
								Loader="{x:Static app:App.ImageLoaderInstance}"
								FallbackImage="{x:Static app:App.FallbackImage}"
								Height="60" 
								Width="60" 
								Source="{Binding Path=Track, Converter={StaticResource MetadataImageConverter}}">
								<Interaction.Behaviors>
									<EventTriggerBehavior EventName="Tapped">
										<InvokeCommandAction 
											Command="{Binding #lbTracks.((vm:TracksViewModel)DataContext).ClickedCommand}"
											CommandParameter="{Binding Path=.}"/>
									</EventTriggerBehavior>
								</Interaction.Behaviors>
							</asyncImageLoader:AdvancedImage>
						</Border>

						<StackPanel Background="Transparent" 
									Grid.Column="1" 
									Margin="0,0,10,0"
									VerticalAlignment="Center">
							<Interaction.Behaviors>
								<EventTriggerBehavior EventName="Tapped">
									<InvokeCommandAction 
										Command="{Binding #lbTracks.((vm:TracksViewModel)DataContext).ClickedCommand}"
										CommandParameter="{Binding Path=.}"/>
								</EventTriggerBehavior>
							</Interaction.Behaviors>
							<TextBlock Text="{Binding Track.Name}" 
									   TextTrimming="CharacterEllipsis" 
									   FontWeight="SemiBold" />
							<TextBlock Text="{Binding Track.artists, Converter={StaticResource ArtistsToStringConverter}}" 
									   Opacity="0.7"  
									   TextTrimming="CharacterEllipsis" 
									   FontSize="12" />
						</StackPanel>

						<TextBlock Grid.Column="2" 
								   Text="{Binding Track.duration, Converter={StaticResource FriendlyTimeConverter}}" 
								   VerticalAlignment="Center"
								   Opacity="0.7"
								   Margin="0,0,15,0" />

						<Button Grid.Column="3"
								Classes="iconButton navButton"
								Command="{Binding TrackAltMenuCommand}"
								VerticalAlignment="Center">
							<materialIcons:MaterialIcon Kind="MoreVert" Width="25" Height="25" />
						</Button>
					</Grid>
				</DataTemplate>
			</ListBox.ItemTemplate>
		</ListBox>
		
		<!-- Loading Indicator -->
		<Grid Grid.Row="0" 
			  IsVisible="{Binding IsLoading}"
			  Background="#80000000"
			  ZIndex="1">
			<StackPanel HorizontalAlignment="Center" 
						VerticalAlignment="Center"
						IsVisible="{Binding !Tracks.Count}">
				<ProgressBar IsIndeterminate="True" Width="100" />
				<TextBlock Text="Loading tracks..." 
						   HorizontalAlignment="Center" 
						   Margin="0,10,0,0" />
			</StackPanel>
		</Grid>
		
		<!-- Track Count Display -->
		<Border Grid.Row="1" 
				Background="#1A1A1A" 
				Padding="10,5"
				BorderBrush="#333333"
				BorderThickness="0,1,0,0">
			<StackPanel Orientation="Horizontal" 
						HorizontalAlignment="Center"
						Spacing="5">
				<TextBlock Opacity="0.7">
					<Run Text="{Binding Tracks.Count}" />
					<Run Text="tracks loaded" />
				</TextBlock>
				<TextBlock Text="• Load more available" 
						   Opacity="0.7"
						   IsVisible="{Binding HasMoreItems}" />
			</StackPanel>
		</Border>
	</Grid>
</UserControl>