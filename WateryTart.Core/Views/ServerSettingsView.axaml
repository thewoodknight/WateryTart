<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:vm="clr-namespace:WateryTart.Core.ViewModels"
             xmlns:discovery="clr-namespace:WateryTart.Core.Services.Discovery"
             mc:Ignorable="d" d:DesignWidth="500" d:DesignHeight="600"
             x:Class="WateryTart.Core.Views.ServerSettingsView"
             x:DataType="vm:ServerSettingsViewModel">

  <ScrollViewer>
    <StackPanel Margin="20" Spacing="16" MaxWidth="400">

      <!-- Current Connection Section -->
      <TextBlock Text="Current Connection" FontSize="18" FontWeight="Bold" />

      <Border Background="#33FFFFFF" CornerRadius="8" Padding="16">
        <StackPanel Spacing="12">
          <StackPanel Spacing="4">
            <TextBlock Text="Server" FontWeight="SemiBold" FontSize="12" Foreground="Gray" />
            <TextBlock Text="{Binding CurrentServer}" FontSize="14" />
          </StackPanel>

          <StackPanel Spacing="4">
            <TextBlock Text="Username" FontWeight="SemiBold" FontSize="12" Foreground="Gray" />
            <TextBlock Text="{Binding CurrentUsername}" FontSize="14" />
          </StackPanel>

          <StackPanel Spacing="4">
            <TextBlock Text="Password" FontWeight="SemiBold" FontSize="12" Foreground="Gray" />
            <TextBlock Text="{Binding MaskedPassword}" FontSize="14" />
          </StackPanel>
        </StackPanel>
      </Border>

      <Separator Margin="0,8" />

      <!-- Reconfigure Section -->
      <TextBlock Text="Change Server" FontSize="18" FontWeight="Bold" />

      <!-- Success Message -->
      <Border Background="#1E7E34"
              BorderBrush="#28A745"
              BorderThickness="1"
              CornerRadius="4"
              IsVisible="{Binding ShowSuccess}"
              Padding="12">
        <TextBlock Text="Server configuration updated successfully!"
                   Foreground="White"
                   FontSize="12" />
      </Border>

      <!-- Error Message -->
      <Border Background="#FFF7CCCF"
              BorderBrush="#FFE81123"
              BorderThickness="1"
              CornerRadius="4"
              IsVisible="{Binding HasError}"
              Padding="12">
        <TextBlock Text="{Binding ErrorMessage}"
                   Foreground="#E81123"
                   TextWrapping="Wrap"
                   FontSize="12" />
      </Border>

      <!-- Loading Message -->
      <Border Background="#F7FFF7"
              BorderBrush="#107C10"
              BorderThickness="1"
              CornerRadius="4"
              IsVisible="{Binding IsLoading}"
              Padding="12">
        <TextBlock Text="Connecting..."
                   Foreground="#107C10"
                   FontSize="12" />
      </Border>

      <!-- Home Assistant Addon Warning -->
      <Border Background="#FFF8E6"
              BorderBrush="#FFA500"
              BorderThickness="1"
              CornerRadius="4"
              IsVisible="{Binding IsHomeAssistantAddon}"
              Padding="8">
        <TextBlock Foreground="#996300"
                   TextWrapping="Wrap"
                   FontSize="11">
          HA Addon detected. Create a user in Music Assistant (Settings - Users) and use those credentials here.
        </TextBlock>
      </Border>

      <!-- Discovered Servers -->
      <StackPanel Spacing="4">
        <Grid ColumnDefinitions="*,Auto">
          <TextBlock Text="Discovered Servers" FontWeight="SemiBold" Grid.Column="0" />
          <StackPanel Orientation="Horizontal" Grid.Column="1" Spacing="8">
            <TextBlock Text="Scanning..."
                       FontSize="11"
                       Foreground="Gray"
                       VerticalAlignment="Center"
                       IsVisible="{Binding IsScanning}" />
            <Button Command="{Binding RefreshServersCommand}"
                    IsEnabled="{Binding !IsScanning}"
                    Padding="8,4"
                    FontSize="11">
              Refresh
            </Button>
          </StackPanel>
        </Grid>
        <ComboBox ItemsSource="{Binding DiscoveredServers}"
                  SelectedItem="{Binding SelectedServer}"
                  Height="36"
                  HorizontalAlignment="Stretch"
                  IsEnabled="{Binding !IsLoading}">
          <ComboBox.ItemTemplate>
            <DataTemplate x:DataType="discovery:DiscoveredServer">
              <StackPanel Orientation="Horizontal" Spacing="8">
                <TextBlock Text="{Binding DisplayName}" FontWeight="SemiBold" />
                <TextBlock Text="{Binding Version, StringFormat='v{0}'}"
                           Foreground="Gray"
                           FontSize="10"
                           VerticalAlignment="Center"
                           IsVisible="{Binding Version, Converter={x:Static StringConverters.IsNotNullOrEmpty}}" />
              </StackPanel>
            </DataTemplate>
          </ComboBox.ItemTemplate>
        </ComboBox>
        <TextBlock Text="No servers found. Click Refresh or enter address manually below."
                   FontSize="11"
                   Foreground="Gray"
                   TextWrapping="Wrap"
                   IsVisible="{Binding !DiscoveredServers.Count}" />
      </StackPanel>

      <!-- Server Address -->
      <StackPanel Spacing="4">
        <TextBlock Text="Server Address" FontWeight="SemiBold" />
        <TextBox Height="36"
                 Text="{Binding Server}"
                 Watermark="192.168.1.100:8095"
                 IsEnabled="{Binding !IsLoading}" />
        <TextBlock Text="Auto-filled from selection above, or enter manually"
                   FontSize="11"
                   Foreground="Gray" />
      </StackPanel>

      <!-- Username -->
      <StackPanel Spacing="4">
        <TextBlock Text="Username" FontWeight="SemiBold" />
        <TextBox Height="36"
                 Text="{Binding Username}"
                 Watermark="Username"
                 IsEnabled="{Binding !IsLoading}" />
      </StackPanel>

      <!-- Password -->
      <StackPanel Spacing="4">
        <TextBlock Text="Password" FontWeight="SemiBold" />
        <TextBox PasswordChar="*"
                 Height="36"
                 Text="{Binding Password}"
                 Watermark="Password"
                 IsEnabled="{Binding !IsLoading}" />
      </StackPanel>

      <!-- Save Button -->
      <Button Command="{Binding SaveCommand}"
              Height="40"
              FontSize="14"
              FontWeight="SemiBold"
              HorizontalAlignment="Stretch"
              IsEnabled="{Binding !IsLoading}">
        Save Changes
      </Button>

    </StackPanel>
  </ScrollViewer>
</UserControl>
