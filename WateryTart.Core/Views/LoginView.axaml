<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:vm="clr-namespace:WateryTart.Core.ViewModels"
             xmlns:discovery="clr-namespace:WateryTart.Core.Services.Discovery"
             mc:Ignorable="d" d:DesignWidth="800" d:DesignHeight="600"
             x:Class="WateryTart.Core.Views.LoginView"
             x:DataType="vm:LoginViewModel">
  <UserControl.Resources>
    <SolidColorBrush x:Key="ErrorBrush">#FFE81123</SolidColorBrush>
    <SolidColorBrush x:Key="SuccessBrush">#107C10</SolidColorBrush>
    <SolidColorBrush x:Key="WarningBrush">#FFA500</SolidColorBrush>
  </UserControl.Resources>

  <Grid VerticalAlignment="Center" HorizontalAlignment="Center">
    <StackPanel Width="380" Spacing="12">
      <!-- Header -->
      <TextBlock FontSize="28" FontWeight="Bold">
        Login
      </TextBlock>

      <!-- Error Message Display -->
      <Border Background="#FFF7CCCF"
              BorderBrush="#FFE81123"
              BorderThickness="1"
              CornerRadius="4"
              IsVisible="{Binding HasError}"
              Padding="12">
        <StackPanel Spacing="4">
          <TextBlock FontWeight="Bold" Foreground="#E81123" FontSize="12">
            Error
          </TextBlock>
          <TextBlock Text="{Binding ErrorMessage}"
                     Foreground="#E81123"
                     TextWrapping="Wrap"
                     FontSize="12" />
        </StackPanel>
      </Border>

      <!-- Loading/Success Message Display -->
      <Border Background="#F7FFF7"
              BorderBrush="#107C10"
              BorderThickness="1"
              CornerRadius="4"
              IsVisible="{Binding IsLoading}"
              Padding="12">
        <TextBlock Text="Logging in..."
                   Foreground="#107C10"
                   FontSize="12" />
      </Border>

      <!-- Home Assistant Addon Warning -->
      <Border Background="#FFF8E6"
              BorderBrush="#FFA500"
              BorderThickness="1"
              CornerRadius="4"
              IsVisible="{Binding IsHomeAssistantAddon}"
              Padding="8">
        <TextBlock Foreground="#996300"
                   TextWrapping="Wrap"
                   FontSize="11">
          HA Addon detected. Create a user in Music Assistant (Settings â†’ Users) and use those credentials here.
        </TextBlock>
      </Border>

      <!-- Discovered Servers Section -->
      <StackPanel Spacing="4">
        <Grid ColumnDefinitions="*,Auto">
          <Label Content="Discovered Servers" FontWeight="SemiBold" Grid.Column="0" />
          <StackPanel Orientation="Horizontal" Grid.Column="1" Spacing="8">
            <TextBlock Text="Scanning..."
                       FontSize="11"
                       Foreground="Gray"
                       VerticalAlignment="Center"
                       IsVisible="{Binding IsScanning}" />
            <Button Command="{Binding RefreshServersCommand}"
                    IsEnabled="{Binding !IsScanning}"
                    Padding="8,4"
                    FontSize="11">
              Refresh
            </Button>
          </StackPanel>
        </Grid>
        <ComboBox ItemsSource="{Binding DiscoveredServers}"
                  SelectedItem="{Binding SelectedServer}"
                  Height="36"
                  HorizontalAlignment="Stretch"
                  IsEnabled="{Binding !IsLoading}">
          <ComboBox.ItemTemplate>
            <DataTemplate x:DataType="discovery:DiscoveredServer">
              <StackPanel Orientation="Horizontal" Spacing="8">
                <TextBlock Text="{Binding DisplayName}" FontWeight="SemiBold" />
                <TextBlock Text="{Binding Version, StringFormat='v{0}'}"
                           Foreground="Gray"
                           FontSize="10"
                           VerticalAlignment="Center"
                           IsVisible="{Binding Version, Converter={x:Static StringConverters.IsNotNullOrEmpty}}" />
              </StackPanel>
            </DataTemplate>
          </ComboBox.ItemTemplate>
        </ComboBox>
        <TextBlock Text="No servers found. Click Refresh or enter address manually below."
                   FontSize="11"
                   Foreground="Gray"
                   TextWrapping="Wrap"
                   IsVisible="{Binding !DiscoveredServers.Count}" />
      </StackPanel>

      <!-- Server Input (manual entry) -->
      <StackPanel Spacing="4">
        <Label Content="Server Address" FontWeight="SemiBold" />
        <TextBox Height="36"
                 TextWrapping="Wrap"
                 Text="{Binding Server}"
                 Watermark="192.168.1.100:8095"
                 IsEnabled="{Binding !IsLoading}" />
        <TextBlock Text="Auto-filled from selection above, or enter manually"
                   FontSize="11"
                   Foreground="Gray" />
      </StackPanel>

      <!-- Username Input -->
      <StackPanel Spacing="4">
        <Label Content="Username" FontWeight="SemiBold" />
        <TextBox Height="36"
                 TextWrapping="Wrap"
                 Text="{Binding Username}"
                 Watermark="Home Assistant username"
                 IsEnabled="{Binding !IsLoading}" />
      </StackPanel>

      <!-- Password Input -->
      <StackPanel Spacing="4">
        <Label Content="Password" FontWeight="SemiBold" />
        <TextBox PasswordChar="*"
                 Watermark="Home Assistant password"
                 Height="36"
                 TextWrapping="Wrap"
                 Text="{Binding Password}"
                 IsEnabled="{Binding !IsLoading}" />
      </StackPanel>

      <!-- Sign In Button -->
      <Button Command="{Binding LoginCommand}"
              Height="40"
              FontSize="14"
              FontWeight="SemiBold"
              IsEnabled="{Binding !IsLoading}">
        <StackPanel Orientation="Horizontal" Spacing="8" HorizontalAlignment="Center">
          <TextBlock Text="Sign In" VerticalAlignment="Center" />
        </StackPanel>
      </Button>
    </StackPanel>
  </Grid>
</UserControl>
